<!DOCTYPE html>
<html lang="en">
  <head>
    <link charset="UTF-8" />
    <style>
      html,
      body {
        overflow: auto;
        font-family: Arial;
        font-size: 16px;
        color: #fff;
        /*height: 100%;*/
      }

      body {
        /*overflow: auto;*/
        background: #10131c;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        -webkit-font-smoothing: antialiased;
        -webkit-tap-highlight-color: transparent;
      }

      button {
        font-family: Arial;
        font-size: 16px;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #4CAF50;
        color: #fff;
        cursor: pointer;
        margin-right: 10px;
        margin-top: 20px;
        width: 250px;
      }

      button:disabled {
        background-color: #ccc;
        cursor: default;
      }

      button:disabled:hover {
          background-color: #ccc;
          cursor: not-allowed;
      }

      h1 {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 0px;
        font-size: 3.5rem;
        margin-bottom: 0px;
      }

      #status {
        display: flex;
        font-size: 1.2rem;
        justify-content: center;
        padding-right: 50px;
        /*color: #e63939;
        color: #3eb337;*/
      }

      #dash {
        display: flex;
        font-size: 1.2rem;
        justify-content: center;
        /*color: #e63939;
        color: #3eb337;*/
      }

      #timer {
        display: flex;
        font-size: 1.2rem;
        padding-left: 50px;
        justify-content: center;
        /*color: #e63939;
        color: #3eb337;*/
      }

      .info {
        display: flex;
        flex-direction: row;
        justify-content: center;
        padding-top: 15px;
      }

      .title {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        padding: 30px 0px;
        padding-bottom: 150px;
      }

      button:hover {
          background-color: #409e3a;
      }

      .control {
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      #settingsButton {
        display: block;
        position: static;
        top: 50%;
        left: 50%;
        transform: translate(670%, -1294%);
        background-color: #dbdbdb;
        text-align: center;
        width: 50px;
        height: 50px;
        margin: 0px 0px;
        padding: 0px 0px;
      }

      #settingsButton:hover {
        cursor: pointer;
        background-color: #b1bfd8;
      }

      #settingsButton:disabled:hover {
        background-color: #dbdbdb;
        cursor: not-allowed;
      }

      #settingsIcon {
        width: 35px;
        height: 35px;
        display: inline-block;
        vertical-align: middle;
      }

      .settings-modal {
        display: none;
        position: fixed;
        z-index: 1;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
      }

      .settings-content {
        font-size: 1rem;
        font-weight: 500;
        background-color: #dbdbdb;
        color: black;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 60%;
        max-width: 800px;
      }

      #resolution,
      #frameRate {
        display: flex;
        flex-direction: column;
        padding: 0px 20px;
        width: 200px;
      }

      /*
      #mic {
        width: 20px;
        height: 14px;
      }
      */

      #sys {
        width: 20px;
        height: 14px;
      }

      .settings-close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
      }

      .settings-close:hover,
      .settings-close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      #downloadLink {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        margin-top: 20px;
      }

      #downloadLink {
        font-family: Arial;
        font-size: 16px;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #008CBA;
        color: #fff;
        text-decoration: none;
        margin-right: 10px;
        text-align: center;
        width: 210px;
        align-items: center;
      }

      #downloadLink:hover {
        background-color: #006F8B;
      }

      #refreshButton {
        font-family: Arial;
        font-size: 16px;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        background-color: #4CAF50;
        color: #fff;
        cursor: pointer;
        margin-top: 20px;
      }

      #refreshButton:hover {
          background-color: #409e3a;
      }

      #refreshButton:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      #videoPreview {
        display: flex;
        flex-direction: column;
        margin-right: 200px;
        /* top: 1;
        left: 0;
        object-fit: fill;
        z-index: 1; */
        width: 650px;
        height: 366px;
        background-color: black;
      }

      .page {
        display: flex;
        padding: 10px 10px;
        flex-direction: row;
      }

      #video {
        display: none;
        /*position: fixed;*/
        align-items: center;
        margin-top: 150PX;
        background-color: black;
        top: 0;
        width: 1000px;
        height: 563px;

      }

      .recorded {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .modal {
          display: none;
          position: fixed;
          z-index: 1;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          overflow: auto;
        }
        
        .modal-content {
          background-color: #dbdbdb;
          color: black;
          margin: 15% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 60%;
          max-width: 800px;
        }
        
        .close {
          color: #aaa;
          float: right;
          font-size: 28px;
          font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
          color: black;
          text-decoration: none;
          cursor: pointer;
        }
        
      #aboutLink {
        margin-top: 300px;
        margin-bottom: 30px;
      }
    </style>
    <link rel="shortcut icon" type="image/x-icon" href="assets/favicon.ico" />
    <title>JK ScreenRecorder</title>
  </head>
  <body>
    <div class="title">
      <h1>JK Screen-Recorder</h1>
      <!--<p id="status"></p>-->
      	<div class="info">
        <p id="status"></p>
        <p id="dash"></p>
        <p id="timer"></p>
        </div>
    </div>
    <div class="page">
      <video src="" id="videoPreview" muted></video>
      <div class="control">
        <button id="startButton">Start Recording</button>
        <button id="stopButton" disabled>Stop Recording</button>
        <button id="pauseButton" disabled>Pause Recording</button>
        <button id="refreshButton">Refresh</button>
      </div>
    </div>
    <button id="settingsButton">
      <img id="settingsIcon" src="assets/settings.png" alt="Settings" />
    </button>
    <div id="settings" class="settings-modal">
      <div class="settings-content">
        <span class="settings-close">&times;</span>
        <h2>Settings</h2>
        <p>
          Framerate:
          <select id="frameRate">
            <option>120</option>
            <option>60</option>
            <option selected>30</option>
            <option>24</option>
          </select>
        </p>
        <p>
          Recording resolution:<select id="resolution">
            <option selected>Fit-Screen</option>
            <option>4k</option>
            <option>1080p</option>
            <option>720p</option>
            <option>360p</option>
          </select>
        </p>
        <!--<p><input type="checkbox" id="mic" /> Record microphone audio</p>-->
        <p><input type="checkbox" id="sys" checked /> Record system audio</p>
      </div>
    </div>
    <script>
      var settings = document.getElementById("settings");
      var buttonSettings = document.getElementById("settingsButton");
      var spanSettings = document.getElementsByClassName("settings-close")[0];

      buttonSettings.onclick = function() {
        settings.style.display = "block";
        //settings.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      spanSettings.onclick = function() {
        settings.style.display = "none";
      }

      window.onclick = function(event) {
        if (event.target == settings) {
          settings.style.display = "none";
        }
      }
    </script>
    <div class="recorded">
      <video src="" id="video"></video>
      <a id="downloadLink" style="display: none">Download Video</a>
    </div>
    <script>
      const startButton = document.getElementById('startButton');
      const stopButton = document.getElementById('stopButton');
      const downloadLink = document.getElementById('downloadLink');
      const refreshButton = document.getElementById('refreshButton');
      const pauseButton = document.getElementById('pauseButton');
      const status = document.getElementById('status');
      const dash = document.getElementById('dash');
      const timer = document.getElementById('timer');
      const videoContainer = videoPreview.parentNode;
      const video = document.getElementById('video');
      const frameRate = document.querySelector('#frameRate');
      const resolution = document.querySelector('#resolution');
      const settingsButton = document.getElementById('settingsButton');


      const sysCheckbox = document.getElementById('sys');
      let sys = true;
      sysCheckbox.addEventListener('click', () => {
        sys = sysCheckbox.checked;
      });

      //const micCheckbox = document.getElementById('mic');
      //let mic = false;
      //micCheckbox.addEventListener('click', () => {
      //  mic = micCheckbox.checked;
      //});

      let mediaRecorder;
      let recordedChunks = [];

      startButton.addEventListener('click', async () => {
        try {
          mediaRecorder = new MediaRecorder(await navigator.mediaDevices.getDisplayMedia(MediaConstraints()));
        } catch (e) {
          if (e.message.includes("audio source")) {
            console.log("Please allow usage of microphone in order to record microphone audio");
          } else {
            console.log("Please select one of screens and then click 'Share' in order to record");
          }
          return;
        }

        //if (mic === true) {
        //  voice = new MediaRecorder(await navigator.mediaDevices.getUserMedia({ video: false, audio: mic }));
        //}
        startTimer()
        timer.style.color = "#3eb337";
        status.style.color = "#3eb337";
        dash.style.color = "#3eb337";
        status.textContent = "Recording";
        dash.textContent = "-";
        document.title = "Recording - JK ScreenRecorder";
        refreshButton.disabled = true;
        settingsButton.disabled = true;

        const videoPreview = document.getElementById('videoPreview');

        //videoPreview.width = Math.ceil(screen.width / 3);
        //videoPreview.height = Math.ceil(screen.height / 3);

        videoPreview.srcObject = mediaRecorder.stream;
        videoPreview.play();

        mediaRecorder.addEventListener('dataavailable', e => {
          recordedChunks.push(e.data);
        });

        mediaRecorder.addEventListener('stop', () => {
          const recordedBlob = new Blob(recordedChunks, { type: 'video/mp4; codecs = H264' }); //type: 'video/mp4'

          videoPreview.style.display = 'none';
          //document.body.removeChild(videoPreview);

          if (videoContainer.contains(videoPreview)) {
            videoContainer.removeChild(videoPreview);
          }

          downloadRecordedVideo(recordedBlob);

          recordedChunks = [];
          mediaRecorder = null;
        });

        mediaRecorder.start();
        pauseButton.disabled = false;
        startButton.disabled = true;
        stopButton.disabled = false;

        let RecordingPaused = false;
        
        mediaRecorder.addEventListener('pause', () => {
          RecordingPaused = true;
          pauseButton.textContent = 'Resume Recording';
        });
        
        mediaRecorder.addEventListener('resume', () => {
          RecordingPaused = false;
          pauseButton.textContent = 'Pause Recording';
        });
        
        pauseButton.addEventListener('click', () => {
          if (mediaRecorder.state === 'recording') {
            mediaRecorder.pause();
            stopTimer();
            timer.style.color = "#e63939";
            dash.style.color = "#e63939";
            status.style.color = "#e63939";
            status.textContent = "Paused";
            dash.textContent = "-";
            document.title = "Paused - JK ScreenRecorder";
          } else if (RecordingPaused) {
            mediaRecorder.resume();
            startTimer();
            timer.style.color = "#3eb337";
            dash.style.color = "#3eb447";
            status.style.color = "#3eb337";
            status.textContent = "Recording";
            dash.textContent = "-";
            document.title = "Recording - JK ScreenRecorder";
          }
        });
      });

      stopButton.addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
          mediaRecorder.stop();
          stopTimer();
          mediaRecorder.stream.getTracks().forEach(track => track.stop());
          status.style.color = "#e2cb45";
          dash.style.color = "#e2cb45";
          timer.style.color = "#e2cb45";
          document.title = "JK ScreenRecorder";

          startButton.disabled = false;
          settingsButton.disabled = false;
          stopButton.disabled = true;
          pauseButton.disabled = true;

          setTimeout(() => {
              refreshButton.disabled = false;
              status.textContent = "";
              timer.textContent = "";
              dash.textContent = "";
          }, 5000);

          //setTimeout(() => {
          //  location.reload();
          //}, 10000);
        }
      });

      function MediaConstraints() {
        var Constraints = {}
        Constraints.audio = sys; //sys;
        Constraints.video = { mediaSource: "screen" };
        Constraints.video.frameRate = frameRate;
        
        switch (resolution.value) {
            case 'Fit-Screen':
                Constraints.video.width = screen.width;
                Constraints.video.height = screen.height;
                break;
            case '4K':
                Constraints.video.width = 3840;
                Constraints.video.height = 2160;
                break;
            case '1080p':
                Constraints.video.width = 1920;
                Constraints.video.height = 1080;
                break;
            case '720p':
                Constraints.video.width = 1280;
                Constraints.video.height = 720;
                break;
            case '480p':
                Constraints.video.width = 854;
                Constraints.video.height = 480;
                break;
            case '360p':
                Constraints.video.width = 640;
                Constraints.video.height = 360;
                break;
        }
        return Constraints;
      }

      let recorded = false;

      refreshButton.addEventListener('click', () => {
        if (recorded) {
          if (confirm("Are you sure you want to lose the video by refreshing the page?")) {
            location.reload();
          }
        } else {
          location.reload();
        }
      });

      var hr = 0;
      var min = 0;
      var sec = 0;
      var stoptime = true;

      function startTimer() {
        if (stoptime == true) {
          stoptime = false;
          timerCycle();
        }
      }
      function stopTimer() {
        if (stoptime == false) {
          stoptime = true;
        }
      }

      function timerCycle() {
        if (stoptime == false) {
          sec = parseInt(sec);
          min = parseInt(min);
          hr = parseInt(hr);

          sec = sec + 1;

          if (sec == 60) {
            min = min + 1;
            sec = 0;
          }
          if (min == 60) {
            hr = hr + 1;
            min = 0;
            sec = 0;
          }

          if (sec < 10 || sec == 0) {
            sec = '0' + sec;
          }
          if (min < 10 || min == 0) {
            min = '0' + min;
          }
          if (hr < 10 || hr == 0) {
            hr = '0' + hr;
          }

          timer.textContent = hr + ':' + min + ':' + sec;

          setTimeout("timerCycle()", 1000);
        }
      }

      function downloadRecordedVideo(recordedBlob) {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const date = now.getDate();
        const hours = now.getHours();
        const minutes = now.getMinutes();
        const seconds = now.getSeconds();

        const timestamp = `${hours}-${minutes}-${seconds}_${date}-${month}-${year}`;
        const fileName = `recorded-video_${timestamp}.mp4`;

        const url = URL.createObjectURL(recordedBlob);
        downloadLink.href = url;
        downloadLink.download = fileName;
        downloadLink.style.display = "block";

        video.src = url;
        video.controls = true;
        //video.classList.add('video-player');
        video.style.display = "flex";
        video.scrollIntoView({ behavior: "smooth", block: "center" });
        recorded = true;
        video.play();
      }
    </script>
    <a href="#" id="aboutLink">About</a>
    <div id="aboutModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>About JK Screen-Recorder</h2>
        <p>
          This is a screen recording tool created by Josakko that allows you to
          record your screen and save the recording as a video file. Visit my
          github <a href="https://github.com/Josakko">here</a>.
        </p>
        <p>
          To use this tool, simply click the "Start Recording" button to start
          recording your screen and then click the "Stop Recording" button when
          you are finished, finally download recorded video using "Download
          File" button. If you are recording multiple videos please click on
          "Refresh" button after you download your video. If you need any help
          contact me on my
          <a href="https://discord.gg/xgET5epJE6">discord server</a>.
        </p>
      </div>
    </div>
    <script>
      var modal = document.getElementById("aboutModal");
      var link = document.getElementById("aboutLink");
      var span = document.getElementsByClassName("close")[0];

      link.onclick = function() {
        modal.style.display = "block";
        //modal.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      span.onclick = function() {
        modal.style.display = "none";
      }

      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }
    </script>
  </body>
</html>
